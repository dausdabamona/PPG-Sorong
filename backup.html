<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#059669">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/svg+xml" href="images/icon-72x72.svg">
    <title>Backup & Database - PPG Sorong</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/pwa-mobile.css">
    <style>
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
        .stat-card { background: white; padding: 1.25rem; border-radius: 0.75rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08); text-align: center; }
        .stat-value { font-size: 2rem; font-weight: 700; color: #059669; }
        .stat-label { font-size: 0.8rem; color: #6b7280; margin-top: 0.25rem; }
        
        .tabs { display: flex; border-bottom: 2px solid #e5e7eb; margin-bottom: 1rem; overflow-x: auto; }
        .tab { padding: 0.75rem 1.25rem; cursor: pointer; font-weight: 500; color: #6b7280; border-bottom: 2px solid transparent; margin-bottom: -2px; white-space: nowrap; }
        .tab:hover { color: #059669; }
        .tab.active { color: #059669; border-bottom-color: #059669; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .table-list { display: grid; gap: 0.5rem; }
        .table-item { background: white; border-radius: 0.5rem; padding: 0.75rem 1rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.05); cursor: pointer; transition: all 0.2s; }
        .table-item:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.1); transform: translateY(-1px); }
        .table-item.active { border-left: 3px solid #059669; background: #f0fdf4; }
        .table-name { font-weight: 600; font-size: 0.9rem; }
        .table-badge { font-size: 0.7rem; padding: 0.2rem 0.5rem; border-radius: 1rem; }
        .table-badge.table { background: #dbeafe; color: #1d4ed8; }
        .table-badge.view { background: #fef3c7; color: #b45309; }
        .table-count { font-size: 0.75rem; color: #6b7280; }
        
        .detail-panel { background: white; border-radius: 0.75rem; padding: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .detail-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 1px solid #e5e7eb; }
        .detail-title { font-size: 1.1rem; font-weight: 600; color: #1f2937; }
        .detail-actions { display: flex; gap: 0.5rem; }
        
        .schema-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; margin-bottom: 1rem; }
        .schema-table th, .schema-table td { padding: 0.5rem; text-align: left; border-bottom: 1px solid #e5e7eb; }
        .schema-table th { background: #f9fafb; font-weight: 600; color: #374151; }
        .schema-table tr:hover { background: #f0fdf4; }
        .col-type { color: #059669; font-family: monospace; font-size: 0.75rem; }
        .col-nullable { font-size: 0.65rem; padding: 0.15rem 0.4rem; border-radius: 0.25rem; }
        .col-nullable.yes { background: #fef3c7; color: #b45309; }
        .col-nullable.no { background: #fee2e2; color: #dc2626; }
        .col-pk { background: #dbeafe; color: #1d4ed8; font-size: 0.65rem; padding: 0.15rem 0.4rem; border-radius: 0.25rem; }
        
        .preview-section { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e5e7eb; }
        .preview-title { font-weight: 600; font-size: 0.85rem; margin-bottom: 0.5rem; color: #374151; }
        .preview-table { width: 100%; border-collapse: collapse; font-size: 0.75rem; overflow-x: auto; display: block; }
        .preview-table th, .preview-table td { padding: 0.4rem 0.5rem; text-align: left; border: 1px solid #e5e7eb; white-space: nowrap; max-width: 200px; overflow: hidden; text-overflow: ellipsis; }
        .preview-table th { background: #059669; color: white; position: sticky; top: 0; }
        .preview-table tr:nth-child(even) { background: #f9fafb; }
        
        .export-section { background: #f0fdf4; border-radius: 0.5rem; padding: 1rem; margin-top: 1rem; }
        .export-title { font-weight: 600; margin-bottom: 0.75rem; color: #065f46; }
        .export-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 0.5rem; }
        .export-item { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: white; border-radius: 0.5rem; cursor: pointer; transition: all 0.2s; }
        .export-item:hover { background: #d1fae5; }
        .export-item input { cursor: pointer; }
        .export-item label { cursor: pointer; font-size: 0.85rem; }
        
        .loading { text-align: center; padding: 2rem; color: #6b7280; }
        .loading-spinner { width: 40px; height: 40px; border: 3px solid #e5e7eb; border-top-color: #059669; border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 1rem; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .empty-state { text-align: center; padding: 3rem; color: #6b7280; }
        .empty-icon { font-size: 3rem; margin-bottom: 0.5rem; opacity: 0.5; }
        
        .access-denied { text-align: center; padding: 3rem; }
        .access-denied-icon { font-size: 4rem; margin-bottom: 1rem; }
        .access-denied h2 { color: #dc2626; margin-bottom: 0.5rem; }
        
        .two-col { display: grid; grid-template-columns: 300px 1fr; gap: 1rem; }
        @media (max-width: 900px) { .two-col { grid-template-columns: 1fr; } }
        
        .search-box { margin-bottom: 1rem; }
        .info-alert { background: #dbeafe; border-left: 4px solid #3b82f6; padding: 0.75rem; border-radius: 0.25rem; font-size: 0.85rem; color: #1e40af; margin-bottom: 1rem; }
    </style>
</head>
<body>
    <div class="app-container">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">PPG</div>
                <div class="sidebar-brand">
                    <div class="sidebar-title">PPG Sorong</div>
                    <div class="sidebar-subtitle">Pembinaan Generasi Penerus</div>
                </div>
                <button class="sidebar-close" onclick="toggleSidebar()">‚úï</button>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section">MENU UTAMA</div>
                <a href="dashboard.html" class="nav-item"><span class="nav-icon">üìä</span><span class="nav-text">Dashboard</span></a>
                <a href="generus.html" class="nav-item"><span class="nav-icon">üë∂</span><span class="nav-text">Data Generus</span></a>
                <a href="pengajian.html" class="nav-item"><span class="nav-icon">üìñ</span><span class="nav-text">Pengajian</span></a>
                <a href="presensi.html" class="nav-item"><span class="nav-icon">‚úÖ</span><span class="nav-text">Presensi</span></a>
                <a href="penilaian-hafalan.html" class="nav-item"><span class="nav-icon">üìà</span><span class="nav-text">Penilaian Hafalan</span></a>
                <div class="nav-section">LAPORAN</div>
                <a href="rapor.html" class="nav-item"><span class="nav-icon">üìã</span><span class="nav-text">Rapor</span></a>
                <a href="laporan-bulanan.html" class="nav-item"><span class="nav-icon">üìÖ</span><span class="nav-text">Laporan Bulanan</span></a>
                <div class="nav-section">PENGATURAN</div>
                <a href="wilayah.html" class="nav-item"><span class="nav-icon">üó∫Ô∏è</span><span class="nav-text">Wilayah</span></a>
                <a href="kurikulum.html" class="nav-item"><span class="nav-icon">üìö</span><span class="nav-text">Kurikulum</span></a>
                <a href="jamaah.html" class="nav-item"><span class="nav-icon">üë•</span><span class="nav-text">Data Jamaah</span></a>
                <a href="users.html" class="nav-item admin-only" style="display:none;"><span class="nav-icon">üë§</span><span class="nav-text">Manajemen User</span></a>
                <a href="pengaturan-akses.html" class="nav-item admin-only" style="display:none;"><span class="nav-icon">üîê</span><span class="nav-text">Pengaturan Akses</span></a>
                <a href="backup.html" class="nav-item active admin-only" style="display:none;"><span class="nav-icon">üíæ</span><span class="nav-text">Backup & Database</span></a>
            </nav>
            <div class="sidebar-footer">
                <div class="sidebar-user">
                    <div class="sidebar-user-avatar" id="sidebarUserAvatar">?</div>
                    <div class="sidebar-user-info">
                        <div class="sidebar-user-name" id="sidebarUserName">Loading...</div>
                        <div class="sidebar-user-role" id="sidebarUserRole">-</div>
                    </div>
                </div>
                <button class="btn btn-sm btn-outline w-100" onclick="logout()">üö™ Keluar</button>
            </div>
        </aside>
        <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>
        
        <main class="main-content">
            <header class="header">
                <div class="header-left">
                    <button class="btn-icon" onclick="toggleSidebar()">‚ò∞</button>
                    <h1 class="header-title">üíæ Backup & Database Explorer</h1>
                </div>
            </header>
            
            <div class="page-content" id="mainContent">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <div>Memeriksa akses...</div>
                </div>
            </div>
        </main>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/api.js"></script>
    <script src="js/sidebar.js"></script>
    
    <script>
        var tables = [];
        var views = [];
        var selectedTable = null;
        var tableColumns = {};
        var tablePreview = {};
        var tableCounts = {};
        
        // Tabel penting untuk export
        var importantTables = [
            'jamaah', 'enrollment', 'wilayah', 'jenjang', 'role', 'users', 'user_role',
            'pengajian', 'presensi', 'progress_jamaah', 'jadwal_rutin',
            'bidang', 'kategori_materi', 'materi_item', 'target_jenjang', 'tahun_ajaran'
        ];
        
        document.addEventListener('DOMContentLoaded', async function() {
            if (!await requireAuth()) return;
            
            // Cek apakah admin
            if (!isAdmin()) {
                showAccessDenied();
                return;
            }
            
            await loadDatabaseInfo();
        });
        
        function showAccessDenied() {
            $('mainContent').innerHTML = `
                <div class="access-denied">
                    <div class="access-denied-icon">üîí</div>
                    <h2>Akses Ditolak</h2>
                    <p>Halaman ini hanya dapat diakses oleh Administrator.</p>
                    <a href="dashboard.html" class="btn btn-primary" style="margin-top:1rem;">‚Üê Kembali ke Dashboard</a>
                </div>
            `;
        }
        
        async function loadDatabaseInfo() {
            try {
                $('mainContent').innerHTML = `
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <div>Memuat informasi database...</div>
                    </div>
                `;
                
                // Get list of tables and views from information_schema
                var tablesResult = await db.rpc('get_database_tables');
                
                if (tablesResult.error) {
                    // Fallback: query langsung ke information_schema
                    var fallbackResult = await db.from('information_schema.tables')
                        .select('table_name, table_type')
                        .eq('table_schema', 'public')
                        .order('table_name');
                    
                    if (fallbackResult.error) {
                        throw new Error('Tidak dapat mengakses informasi database');
                    }
                    
                    processTableList(fallbackResult.data);
                } else {
                    processTableList(tablesResult.data);
                }
                
            } catch (error) {
                console.error('Error:', error);
                // Fallback dengan hardcoded tables
                await loadWithHardcodedTables();
            }
        }
        
        async function loadWithHardcodedTables() {
            // Hardcoded list berdasarkan yang kita tahu
            var knownTables = [
                'jamaah', 'enrollment', 'wilayah', 'jenjang', 'role', 'users', 'user_role',
                'pengajian', 'presensi', 'progress_jamaah', 'jadwal_rutin', 'fase_kehidupan',
                'bidang', 'kategori_materi', 'materi_item', 'target_jenjang', 'tahun_ajaran',
                'pernikahan', 'nilai_karakter', 'tali_keimanan'
            ];
            
            var knownViews = [
                'v_jamaah_lengkap', 'v_generus_aktif', 'v_keluarga', 'v_wilayah_hierarki',
                'v_materi_kurikulum', 'v_pengajian_lengkap', 'v_presensi_lengkap',
                'v_progress_hafalan', 'v_jadwal_rutin_lengkap', 'v_dashboard_stats',
                'v_user_role_lengkap', 'v_statistik_jenjang', 'v_statistik_fase', 'v_daftar_pernikahan'
            ];
            
            tables = knownTables.map(function(t) { return { table_name: t, table_type: 'BASE TABLE' }; });
            views = knownViews.map(function(v) { return { table_name: v, table_type: 'VIEW' }; });
            
            // Get row counts
            for (var i = 0; i < tables.length; i++) {
                try {
                    var countResult = await db.from(tables[i].table_name).select('*', { count: 'exact', head: true });
                    tableCounts[tables[i].table_name] = countResult.count || 0;
                } catch (e) {
                    tableCounts[tables[i].table_name] = '?';
                }
            }
            
            for (var i = 0; i < views.length; i++) {
                try {
                    var countResult = await db.from(views[i].table_name).select('*', { count: 'exact', head: true });
                    tableCounts[views[i].table_name] = countResult.count || 0;
                } catch (e) {
                    tableCounts[views[i].table_name] = '?';
                }
            }
            
            renderMainContent();
        }
        
        function processTableList(data) {
            tables = data.filter(function(t) { return t.table_type === 'BASE TABLE'; });
            views = data.filter(function(t) { return t.table_type === 'VIEW'; });
            renderMainContent();
        }
        
        function renderMainContent() {
            var totalTables = tables.length;
            var totalViews = views.length;
            var totalRows = Object.values(tableCounts).reduce(function(a, b) { return a + (typeof b === 'number' ? b : 0); }, 0);
            
            var html = `
                <!-- Stats -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">${totalTables}</div>
                        <div class="stat-label">üìã Tabel</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${totalViews}</div>
                        <div class="stat-label">üëÅÔ∏è Views</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${formatNumber(totalRows)}</div>
                        <div class="stat-label">üìä Total Rows</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${importantTables.length}</div>
                        <div class="stat-label">‚≠ê Tabel Penting</div>
                    </div>
                </div>
                
                <!-- Tabs -->
                <div class="tabs">
                    <div class="tab active" onclick="switchTab('explorer', this)">üîç Database Explorer</div>
                    <div class="tab" onclick="switchTab('export', this)">üì§ Export Data</div>
                </div>
                
                <!-- Tab: Explorer -->
                <div class="tab-content active" id="tabExplorer">
                    <div class="two-col">
                        <!-- Table List -->
                        <div>
                            <div class="search-box">
                                <input type="text" class="form-control" id="searchTable" placeholder="üîç Cari tabel/view..." oninput="filterTables()">
                            </div>
                            <div class="table-list" id="tableList">
                                ${renderTableList()}
                            </div>
                        </div>
                        
                        <!-- Detail Panel -->
                        <div class="detail-panel" id="detailPanel">
                            <div class="empty-state">
                                <div class="empty-icon">üëà</div>
                                <div>Pilih tabel atau view untuk melihat detailnya</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Tab: Export -->
                <div class="tab-content" id="tabExport">
                    <div class="info-alert">
                        ‚ÑπÔ∏è Export data akan mengunduh file JSON yang berisi data dari tabel-tabel yang dipilih. 
                        File ini dapat digunakan untuk backup atau migrasi data.
                    </div>
                    
                    <div class="export-section">
                        <div class="export-title">üì¶ Pilih Tabel untuk Export</div>
                        <div style="margin-bottom:1rem;">
                            <button class="btn btn-sm btn-outline" onclick="selectAllExport()">‚úÖ Pilih Semua</button>
                            <button class="btn btn-sm btn-outline" onclick="deselectAllExport()">‚ùå Hapus Semua</button>
                            <button class="btn btn-sm btn-outline" onclick="selectImportantExport()">‚≠ê Tabel Penting</button>
                        </div>
                        <div class="export-grid" id="exportGrid">
                            ${renderExportCheckboxes()}
                        </div>
                    </div>
                    
                    <div style="margin-top:1.5rem;display:flex;gap:1rem;flex-wrap:wrap;">
                        <button class="btn btn-primary" onclick="exportSelected()">
                            üì• Export Selected (JSON)
                        </button>
                        <button class="btn btn-secondary" onclick="exportSelectedCSV()">
                            üìä Export Selected (CSV)
                        </button>
                    </div>
                    
                    <div id="exportProgress" style="margin-top:1rem;display:none;">
                        <div class="loading">
                            <div class="loading-spinner"></div>
                            <div id="exportStatus">Mengexport data...</div>
                        </div>
                    </div>
                </div>
            `;
            
            $('mainContent').innerHTML = html;
        }
        
        function renderTableList() {
            var html = '';
            
            // Tables
            html += '<div style="font-size:0.75rem;color:#6b7280;padding:0.5rem 0;font-weight:600;">üìã TABEL (' + tables.length + ')</div>';
            tables.forEach(function(t) {
                var count = tableCounts[t.table_name];
                var countText = count !== undefined ? (count + ' rows') : '';
                var isImportant = importantTables.includes(t.table_name);
                html += '<div class="table-item" onclick="selectTable(\'' + t.table_name + '\', \'table\')" data-name="' + t.table_name + '">';
                html += '<div><span class="table-name">' + (isImportant ? '‚≠ê ' : '') + t.table_name + '</span></div>';
                html += '<div><span class="table-badge table">TABLE</span> <span class="table-count">' + countText + '</span></div>';
                html += '</div>';
            });
            
            // Views
            html += '<div style="font-size:0.75rem;color:#6b7280;padding:0.5rem 0;margin-top:1rem;font-weight:600;">üëÅÔ∏è VIEWS (' + views.length + ')</div>';
            views.forEach(function(v) {
                var count = tableCounts[v.table_name];
                var countText = count !== undefined ? (count + ' rows') : '';
                html += '<div class="table-item" onclick="selectTable(\'' + v.table_name + '\', \'view\')" data-name="' + v.table_name + '">';
                html += '<div><span class="table-name">' + v.table_name + '</span></div>';
                html += '<div><span class="table-badge view">VIEW</span> <span class="table-count">' + countText + '</span></div>';
                html += '</div>';
            });
            
            return html;
        }
        
        function renderExportCheckboxes() {
            var html = '';
            tables.forEach(function(t) {
                var isImportant = importantTables.includes(t.table_name);
                var checked = isImportant ? 'checked' : '';
                html += '<div class="export-item">';
                html += '<input type="checkbox" id="exp_' + t.table_name + '" value="' + t.table_name + '" ' + checked + '>';
                html += '<label for="exp_' + t.table_name + '">' + (isImportant ? '‚≠ê ' : '') + t.table_name + '</label>';
                html += '</div>';
            });
            return html;
        }
        
        function filterTables() {
            var query = $('searchTable').value.toLowerCase();
            var items = document.querySelectorAll('.table-item');
            items.forEach(function(item) {
                var name = item.dataset.name.toLowerCase();
                item.style.display = name.includes(query) ? 'flex' : 'none';
            });
        }
        
        function switchTab(tabId, el) {
            document.querySelectorAll('.tab').forEach(function(t) { t.classList.remove('active'); });
            document.querySelectorAll('.tab-content').forEach(function(c) { c.classList.remove('active'); });
            el.classList.add('active');
            $('tab' + tabId.charAt(0).toUpperCase() + tabId.slice(1)).classList.add('active');
        }
        
        async function selectTable(tableName, type) {
            selectedTable = tableName;
            
            // Update active state
            document.querySelectorAll('.table-item').forEach(function(item) {
                item.classList.remove('active');
                if (item.dataset.name === tableName) item.classList.add('active');
            });
            
            var panel = $('detailPanel');
            panel.innerHTML = '<div class="loading"><div class="loading-spinner"></div><div>Memuat struktur...</div></div>';
            
            try {
                // Get columns
                var columns = await getTableColumns(tableName);
                
                // Get preview data
                var preview = await getTablePreview(tableName);
                
                // Get count
                var countResult = await db.from(tableName).select('*', { count: 'exact', head: true });
                var rowCount = countResult.count || 0;
                
                renderDetailPanel(tableName, type, columns, preview, rowCount);
                
            } catch (error) {
                console.error('Error:', error);
                panel.innerHTML = '<div class="empty-state"><div class="empty-icon">‚ùå</div><div>Gagal memuat detail: ' + error.message + '</div></div>';
            }
        }
        
        async function getTableColumns(tableName) {
            // Try to get from cache
            if (tableColumns[tableName]) return tableColumns[tableName];
            
            // Get sample data to infer columns
            var result = await db.from(tableName).select('*').limit(1);
            
            if (result.data && result.data.length > 0) {
                var cols = Object.keys(result.data[0]).map(function(key) {
                    var val = result.data[0][key];
                    var type = typeof val;
                    if (val === null) type = 'unknown';
                    else if (Array.isArray(val)) type = 'array';
                    else if (type === 'object') type = 'json';
                    
                    return {
                        column_name: key,
                        data_type: type,
                        is_nullable: 'YES'
                    };
                });
                tableColumns[tableName] = cols;
                return cols;
            }
            
            return [];
        }
        
        async function getTablePreview(tableName) {
            if (tablePreview[tableName]) return tablePreview[tableName];
            
            var result = await db.from(tableName).select('*').limit(5);
            tablePreview[tableName] = result.data || [];
            return tablePreview[tableName];
        }
        
        function renderDetailPanel(tableName, type, columns, preview, rowCount) {
            var typeLabel = type === 'table' ? '<span class="table-badge table">TABLE</span>' : '<span class="table-badge view">VIEW</span>';
            
            var html = `
                <div class="detail-header">
                    <div>
                        <div class="detail-title">${tableName}</div>
                        <div style="font-size:0.8rem;color:#6b7280;margin-top:0.25rem;">
                            ${typeLabel} ‚Ä¢ ${columns.length} kolom ‚Ä¢ ${formatNumber(rowCount)} rows
                        </div>
                    </div>
                    <div class="detail-actions">
                        <button class="btn btn-sm btn-outline" onclick="refreshTable('${tableName}')">üîÑ</button>
                        <button class="btn btn-sm btn-primary" onclick="exportSingleTable('${tableName}')">üì• Export</button>
                    </div>
                </div>
                
                <div style="font-weight:600;font-size:0.85rem;margin-bottom:0.5rem;">üìã Struktur Kolom</div>
                <div style="overflow-x:auto;">
                    <table class="schema-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Nama Kolom</th>
                                <th>Tipe Data</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            columns.forEach(function(col, idx) {
                var isPK = col.column_name === 'id';
                html += '<tr>';
                html += '<td>' + (idx + 1) + '</td>';
                html += '<td><strong>' + col.column_name + '</strong>' + (isPK ? ' <span class="col-pk">PK</span>' : '') + '</td>';
                html += '<td><span class="col-type">' + col.data_type + '</span></td>';
                html += '</tr>';
            });
            
            html += '</tbody></table></div>';
            
            // Preview data
            if (preview && preview.length > 0) {
                html += `
                    <div class="preview-section">
                        <div class="preview-title">üëÅÔ∏è Preview Data (5 baris pertama)</div>
                        <div style="overflow-x:auto;max-height:300px;">
                            <table class="preview-table">
                                <thead><tr>
                `;
                
                var previewCols = Object.keys(preview[0]);
                previewCols.forEach(function(col) {
                    html += '<th>' + col + '</th>';
                });
                html += '</tr></thead><tbody>';
                
                preview.forEach(function(row) {
                    html += '<tr>';
                    previewCols.forEach(function(col) {
                        var val = row[col];
                        if (val === null) val = '<em style="color:#9ca3af;">null</em>';
                        else if (typeof val === 'object') val = JSON.stringify(val).substring(0, 50) + '...';
                        else val = escapeHtml(String(val));
                        html += '<td>' + val + '</td>';
                    });
                    html += '</tr>';
                });
                
                html += '</tbody></table></div></div>';
            } else {
                html += '<div class="preview-section"><div class="empty-state" style="padding:1rem;"><div>Tidak ada data</div></div></div>';
            }
            
            $('detailPanel').innerHTML = html;
        }
        
        async function refreshTable(tableName) {
            delete tableColumns[tableName];
            delete tablePreview[tableName];
            await selectTable(tableName, 'table');
        }
        
        function selectAllExport() {
            document.querySelectorAll('#exportGrid input[type="checkbox"]').forEach(function(cb) { cb.checked = true; });
        }
        
        function deselectAllExport() {
            document.querySelectorAll('#exportGrid input[type="checkbox"]').forEach(function(cb) { cb.checked = false; });
        }
        
        function selectImportantExport() {
            document.querySelectorAll('#exportGrid input[type="checkbox"]').forEach(function(cb) {
                cb.checked = importantTables.includes(cb.value);
            });
        }
        
        async function exportSelected() {
            var selected = [];
            document.querySelectorAll('#exportGrid input[type="checkbox"]:checked').forEach(function(cb) {
                selected.push(cb.value);
            });
            
            if (selected.length === 0) {
                showToast('Pilih minimal 1 tabel untuk export', 'error');
                return;
            }
            
            $('exportProgress').style.display = 'block';
            
            var exportData = {
                exported_at: new Date().toISOString(),
                exported_by: currentUserData?.email || 'unknown',
                tables: {}
            };
            
            for (var i = 0; i < selected.length; i++) {
                var tableName = selected[i];
                $('exportStatus').textContent = 'Mengexport ' + tableName + ' (' + (i + 1) + '/' + selected.length + ')...';
                
                try {
                    var result = await db.from(tableName).select('*');
                    exportData.tables[tableName] = {
                        count: result.data ? result.data.length : 0,
                        data: result.data || []
                    };
                } catch (e) {
                    exportData.tables[tableName] = { error: e.message };
                }
            }
            
            // Download JSON
            var blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'ppg_backup_' + new Date().toISOString().split('T')[0] + '.json';
            a.click();
            URL.revokeObjectURL(url);
            
            $('exportProgress').style.display = 'none';
            showToast('Export berhasil! ' + selected.length + ' tabel diexport.', 'success');
        }
        
        async function exportSelectedCSV() {
            var selected = [];
            document.querySelectorAll('#exportGrid input[type="checkbox"]:checked').forEach(function(cb) {
                selected.push(cb.value);
            });
            
            if (selected.length === 0) {
                showToast('Pilih minimal 1 tabel untuk export', 'error');
                return;
            }
            
            $('exportProgress').style.display = 'block';
            
            for (var i = 0; i < selected.length; i++) {
                var tableName = selected[i];
                $('exportStatus').textContent = 'Mengexport ' + tableName + ' (' + (i + 1) + '/' + selected.length + ')...';
                
                try {
                    var result = await db.from(tableName).select('*');
                    if (result.data && result.data.length > 0) {
                        var csv = convertToCSV(result.data);
                        downloadCSV(csv, tableName + '_' + new Date().toISOString().split('T')[0] + '.csv');
                    }
                } catch (e) {
                    console.error('Error export ' + tableName, e);
                }
            }
            
            $('exportProgress').style.display = 'none';
            showToast('Export CSV berhasil!', 'success');
        }
        
        async function exportSingleTable(tableName) {
            showToast('Mengexport ' + tableName + '...', 'info');
            
            try {
                var result = await db.from(tableName).select('*');
                var exportData = {
                    table: tableName,
                    exported_at: new Date().toISOString(),
                    count: result.data ? result.data.length : 0,
                    data: result.data || []
                };
                
                var blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                var url = URL.createObjectURL(blob);
                var a = document.createElement('a');
                a.href = url;
                a.download = tableName + '_' + new Date().toISOString().split('T')[0] + '.json';
                a.click();
                URL.revokeObjectURL(url);
                
                showToast('Export ' + tableName + ' berhasil!', 'success');
            } catch (e) {
                showToast('Gagal export: ' + e.message, 'error');
            }
        }
        
        function convertToCSV(data) {
            if (!data || data.length === 0) return '';
            
            var headers = Object.keys(data[0]);
            var csv = headers.join(',') + '\n';
            
            data.forEach(function(row) {
                var values = headers.map(function(h) {
                    var val = row[h];
                    if (val === null || val === undefined) return '';
                    if (typeof val === 'object') val = JSON.stringify(val);
                    val = String(val).replace(/"/g, '""');
                    if (val.includes(',') || val.includes('"') || val.includes('\n')) {
                        val = '"' + val + '"';
                    }
                    return val;
                });
                csv += values.join(',') + '\n';
            });
            
            return csv;
        }
        
        function downloadCSV(csv, filename) {
            var blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function formatNumber(num) {
            if (typeof num !== 'number') return num;
            return num.toLocaleString('id-ID');
        }
    </script>
</body>
</html>
